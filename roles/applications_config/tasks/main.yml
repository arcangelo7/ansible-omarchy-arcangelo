---
# Alacritty terminal configuration
- name: Configure Alacritty terminal
  ansible.builtin.template:
    src: alacritty.toml.j2
    dest: "{{ ansible_env.HOME }}/.config/alacritty/alacritty.toml"
    mode: '0644'
    backup: yes

# Set Firefox as default browser
- name: Ensure .config directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config"
    state: directory
    mode: '0755'

- name: Set default browser for HTTP/HTTPS
  community.general.ini_file:
    path: "{{ ansible_env.HOME }}/.config/mimeapps.list"
    section: "Default Applications"
    option: "{{ item }}"
    value: "{{ default_browser }}"
    mode: '0644'
    backup: yes
  loop:
    - "text/html"
    - "x-scheme-handler/http"
    - "x-scheme-handler/https"
    - "x-scheme-handler/about"
    - "x-scheme-handler/unknown"

- name: Set default browser via xdg-settings
  ansible.builtin.command:
    cmd: "xdg-settings set default-web-browser {{ default_browser }}"
  changed_when: true
  environment:
    DISPLAY: ":0"

# Set Visual Studio Code as default text editor
- name: Set VSCode as default editor for text files
  community.general.ini_file:
    path: "{{ ansible_env.HOME }}/.config/mimeapps.list"
    section: "Default Applications"
    option: "{{ item }}"
    value: "{{ default_text_editor }}"
    mode: '0644'
    backup: yes
  loop:
    - "text/plain"
    - "text/markdown"
    - "text/x-python"
    - "text/x-yaml"
    - "application/json"
    - "text/x-shellscript"
    - "text/x-csrc"
    - "text/x-c++src"
    - "text/x-java"
    - "text/css"
    - "text/javascript"
    - "application/xml"
    - "text/x-log"
    - "application/x-yaml"
    - "application/x-shellscript"

# Configure web apps to use Brave browser
- name: Backup original omarchy-launch-webapp script
  ansible.builtin.copy:
    src: "{{ ansible_env.HOME }}/.local/share/omarchy/bin/omarchy-launch-webapp"
    dest: "{{ ansible_env.HOME }}/.local/share/omarchy/bin/omarchy-launch-webapp.bak"
    mode: '0755'
    remote_src: yes
    force: no

- name: Configure omarchy-launch-webapp to use Brave for web apps
  ansible.builtin.template:
    src: omarchy-launch-webapp.j2
    dest: "{{ ansible_env.HOME }}/.local/share/omarchy/bin/omarchy-launch-webapp"
    mode: '0755'
    backup: no

# Configure Firefox custom preferences
- name: Find Firefox profile directory
  ansible.builtin.shell: |
    find {{ ansible_env.HOME }}/.mozilla/firefox -maxdepth 1 -name "*.default*" -type d | head -1
  register: firefox_profile
  changed_when: false
  failed_when: firefox_profile.stdout == ""

- name: Deploy Firefox custom preferences (user.js)
  ansible.builtin.template:
    src: firefox-user.js.j2
    dest: "{{ firefox_profile.stdout }}/user.js"
    mode: '0644'
    backup: yes
  when: firefox_profile.stdout != ""

- name: Ensure Firefox distribution directory exists
  ansible.builtin.file:
    path: /usr/lib/firefox/distribution
    state: directory
    mode: '0755'
  become: true

- name: Deploy Firefox enterprise policies (extensions auto-install)
  ansible.builtin.template:
    src: firefox-policies.json.j2
    dest: /usr/lib/firefox/distribution/policies.json
    mode: '0644'
    backup: yes
  become: true

# Hide developer/utility tools from application launcher
- name: Ensure local applications directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/share/applications"
    state: directory
    mode: '0755'

- name: Hide developer tools from application launcher
  ansible.builtin.copy:
    content: |
      [Desktop Entry]
      NoDisplay=true
    dest: "{{ ansible_env.HOME }}/.local/share/applications/{{ item.name }}"
    mode: '0644'
  loop: "{{ hidden_from_launcher }}"
  when: hidden_from_launcher is defined and hidden_from_launcher | length > 0
