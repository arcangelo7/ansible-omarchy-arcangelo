---
# Ghostty terminal configuration
- name: Configure Ghostty terminal
  ansible.builtin.template:
    src: ghostty-config.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/ghostty/config"
    mode: '0644'
    backup: yes

# Set default browser
- name: Ensure .config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config"
    state: directory
    mode: '0755'

- name: Set default browser
  community.general.ini_file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/mimeapps.list"
    section: "Default Applications"
    option: "{{ item }}"
    value: "{{ default_browser }}"
    mode: '0644'
    backup: yes
  loop:
    - "text/html"
    - "x-scheme-handler/http"
    - "x-scheme-handler/https"
    - "x-scheme-handler/about"
    - "x-scheme-handler/unknown"

- name: Check current default browser
  ansible.builtin.command:
    cmd: xdg-settings get default-web-browser
  register: current_browser
  changed_when: false
  failed_when: false

- name: Set system default browser via xdg-settings
  ansible.builtin.command:
    cmd: xdg-settings set default-web-browser {{ default_browser }}
  when: current_browser.stdout != default_browser
  changed_when: true

# Override omarchy-launch-webapp to use Brave for web apps
- name: Ensure ~/.local/bin directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
    state: directory
    mode: '0755'

- name: Deploy Brave webapp wrapper
  ansible.builtin.copy:
    src: omarchy-launch-webapp
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin/omarchy-launch-webapp"
    mode: '0755'

- name: Deploy webapp focus wrapper
  ansible.builtin.copy:
    src: omarchy-launch-or-focus-webapp
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin/omarchy-launch-or-focus-webapp"
    mode: '0755'

# Set Visual Studio Code as default text editor
- name: Set default text editor
  community.general.ini_file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/mimeapps.list"
    section: "Default Applications"
    option: "{{ item }}"
    value: "{{ default_text_editor }}"
    mode: '0644'
    backup: yes
  loop:
    - "text/plain"
    - "text/markdown"
    - "text/x-python"
    - "text/x-yaml"
    - "application/json"
    - "text/x-shellscript"
    - "text/x-csrc"
    - "text/x-c++src"
    - "text/x-java"
    - "text/css"
    - "text/javascript"
    - "application/xml"
    - "text/x-log"
    - "application/x-yaml"
    - "application/x-shellscript"

# Configure Firefox custom preferences
- name: Find Firefox profile directory
  ansible.builtin.shell: |
    find {{ ansible_facts['env']['HOME'] }}/.mozilla/firefox -maxdepth 1 -name "*.default*" -type d | head -1
  register: firefox_profile
  changed_when: false
  failed_when: firefox_profile.stdout == ""

- name: Deploy Firefox user.js
  ansible.builtin.template:
    src: firefox-user.js.j2
    dest: "{{ firefox_profile.stdout }}/user.js"
    mode: '0644'
    backup: yes
  when: firefox_profile.stdout != ""

- name: Ensure Firefox distribution directory exists
  ansible.builtin.file:
    path: /usr/lib/firefox/distribution
    state: directory
    mode: '0755'
  become: true

- name: Deploy Firefox policies
  ansible.builtin.template:
    src: firefox-policies.json.j2
    dest: /usr/lib/firefox/distribution/policies.json
    mode: '0644'
    backup: yes
  become: true

# Configure Thunderbird custom preferences
- name: Find Thunderbird profile directory
  ansible.builtin.shell: |
    find {{ ansible_facts['env']['HOME'] }}/.thunderbird -maxdepth 1 -name "*.default*" -type d | head -1
  register: thunderbird_profile
  changed_when: false
  failed_when: false

- name: Deploy Thunderbird user.js
  ansible.builtin.template:
    src: thunderbird-user.js.j2
    dest: "{{ thunderbird_profile.stdout }}/user.js"
    mode: '0644'
    backup: yes
  when: thunderbird_profile.stdout != ""

- name: Ensure Thunderbird distribution directory exists
  ansible.builtin.file:
    path: /usr/lib/thunderbird/distribution
    state: directory
    mode: '0755'
  become: true
  when: thunderbird_profile.stdout != ""

- name: Deploy Thunderbird policies
  ansible.builtin.template:
    src: thunderbird-policies.json.j2
    dest: /usr/lib/thunderbird/distribution/policies.json
    mode: '0644'
    backup: yes
  become: true
  when: thunderbird_profile.stdout != ""

- name: Ensure local applications directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/share/applications"
    state: directory
    mode: '0755'

- name: Override Thunderbird desktop for XWayland
  ansible.builtin.copy:
    content: |
      [Desktop Entry]
      Name=Thunderbird
      Comment=Send and receive mail with Thunderbird
      GenericName=Mail Client
      Exec=env GDK_BACKEND=x11 thunderbird %u
      Terminal=false
      Type=Application
      Icon=org.mozilla.Thunderbird
      Categories=Network;Email;
      MimeType=message/rfc822;x-scheme-handler/mailto;text/calendar;text/vcard;text/x-vcard;x-scheme-handler/webcal;x-scheme-handler/webcals;x-scheme-handler/mid;
      StartupNotify=true
      StartupWMClass=thunderbird
      Actions=ComposeMessage;OpenAddressBook;

      [Desktop Action ComposeMessage]
      Name=Write new message
      Exec=env GDK_BACKEND=x11 thunderbird -compose

      [Desktop Action OpenAddressBook]
      Name=Open address book
      Exec=env GDK_BACKEND=x11 thunderbird -addressbook
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/share/applications/org.mozilla.Thunderbird.desktop"
    mode: '0644'
  when: thunderbird_profile.stdout != ""

- name: Check if GeForce NOW is installed
  ansible.builtin.stat:
    path: /opt/geforcenow-electron/geforcenow-electron
  register: geforcenow_installed

- name: Override GeForce NOW desktop to disable mic
  ansible.builtin.copy:
    content: |
      [Desktop Entry]
      Encoding=UTF-8
      Name=GeForce NOW
      Comment=Stream games using the Nvidia GeForce NOW service
      Comment[ro]=JoacÄƒ jocuri prin streaming folosind serviciul Nvidia GeForce NOW
      Type=Application
      Exec=/opt/geforcenow-electron/geforcenow-electron --disable-features=MediaStreamPermissionsPolicy
      Icon=nvidia
      StartupWMClass=geforce now
      Categories=Network;Game;
      Keywords=Game;Streaming;Nvidia;GeForce;NOW;GFN;
      Keywords[ro]=Game;Streaming;Joc;Transmisie;Transmisiune;Nvidia;GeForce;NOW;GFN;
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/share/applications/com.github.hmlendea.geforcenow-electron.desktop"
    mode: '0644'
  when: geforcenow_installed.stat.exists

- name: Hide dev tools from launcher
  ansible.builtin.copy:
    content: |
      [Desktop Entry]
      NoDisplay=true
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/share/applications/{{ item }}"
    mode: '0644'
  loop: "{{ hidden_from_launcher }}"
  when: hidden_from_launcher is defined and hidden_from_launcher | length > 0

- name: Ensure Chromium policies directory exists
  ansible.builtin.file:
    path: /etc/chromium/policies/managed
    state: directory
    mode: '0755'
  become: true

- name: Deploy Chromium policies
  ansible.builtin.template:
    src: chromium-policies.json.j2
    dest: /etc/chromium/policies/managed/policies.json
    mode: '0644'
    backup: yes
  become: true

- name: Check if Chromium config directory exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/chromium/Default"
  register: chromium_default_profile

- name: Deploy Chromium preferences template
  ansible.builtin.template:
    src: chromium-preferences.json.j2
    dest: /tmp/chromium-prefs-update.json
    mode: '0644'
  when: chromium_default_profile.stat.exists
  changed_when: false

- name: Merge Chromium custom preferences
  ansible.builtin.shell: |
    PREFS="{{ ansible_facts['env']['HOME'] }}/.config/chromium/Default/Preferences"
    if [ -f "$PREFS" ]; then
      jq -s '.[0] * .[1]' "$PREFS" /tmp/chromium-prefs-update.json > "$PREFS.new"
      # Compare semantically (sorted keys) to handle formatting differences
      if ! diff -q <(jq -S '.' "$PREFS") <(jq -S '.' "$PREFS.new") >/dev/null 2>&1; then
        mv "$PREFS.new" "$PREFS"
        echo "changed"
      else
        rm "$PREFS.new"
      fi
    else
      cp /tmp/chromium-prefs-update.json "$PREFS"
      echo "changed"
    fi
  args:
    executable: /bin/bash
  register: chromium_merge_result
  when: chromium_default_profile.stat.exists
  changed_when: "'changed' in chromium_merge_result.stdout"

- name: Ensure Brave policies directory exists
  ansible.builtin.file:
    path: /etc/brave/policies/managed
    state: directory
    mode: '0755'
  become: true

- name: Deploy Brave policies
  ansible.builtin.template:
    src: brave-policies.json.j2
    dest: /etc/brave/policies/managed/policies.json
    mode: '0644'
    backup: yes
  become: true

- name: Check if Brave config directory exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/BraveSoftware/Brave-Browser/Default"
  register: brave_default_profile

- name: Deploy Brave preferences template
  ansible.builtin.template:
    src: brave-preferences.json.j2
    dest: /tmp/brave-prefs-update.json
    mode: '0644'
  when: brave_default_profile.stat.exists
  changed_when: false

- name: Merge Brave custom preferences
  ansible.builtin.shell: |
    PREFS="{{ ansible_facts['env']['HOME'] }}/.config/BraveSoftware/Brave-Browser/Default/Preferences"
    if [ -f "$PREFS" ]; then
      jq -s '.[0] * .[1]' "$PREFS" /tmp/brave-prefs-update.json > "$PREFS.new"
      # Compare semantically (sorted keys) to handle formatting differences
      if ! diff -q <(jq -S '.' "$PREFS") <(jq -S '.' "$PREFS.new") >/dev/null 2>&1; then
        mv "$PREFS.new" "$PREFS"
        echo "changed"
      else
        rm "$PREFS.new"
      fi
    else
      cp /tmp/brave-prefs-update.json "$PREFS"
      echo "changed"
    fi
  args:
    executable: /bin/bash
  register: brave_merge_result
  when: brave_default_profile.stat.exists
  changed_when: "'changed' in brave_merge_result.stdout"

- name: Configure Waybar start hidden
  ansible.builtin.lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/waybar/config.jsonc"
    regexp: '^\s*"start_hidden":'
    insertafter: '^\s*"height":'
    line: '  "start_hidden": {{ waybar_start_hidden | lower }},'
    backup: true
  when: waybar_start_hidden is defined

- name: Ensure Neovim config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/config"
    state: directory
    mode: '0755'

- name: Configure Neovim spell languages
  ansible.builtin.lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/config/options.lua"
    regexp: '^vim\.opt\.spelllang'
    line: "vim.opt.spelllang = { \"{{ neovim_spell_languages | join('\", \"') }}\" }"
    create: true
    mode: '0644'
    backup: yes

- name: Ensure Neovim spell directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/share/nvim/site/spell"
    state: directory
    mode: '0755'

- name: Download Neovim spell files
  ansible.builtin.get_url:
    url: "https://ftp.nluug.nl/vim/runtime/spell/{{ item }}.utf-8.spl"
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/share/nvim/site/spell/{{ item }}.utf-8.spl"
    mode: '0644'
  loop: "{{ neovim_spell_languages }}"

- name: Ensure Neovim plugins directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/plugins"
    state: directory
    mode: '0755'

- name: Deploy Neovim autocomplete config
  ansible.builtin.copy:
    src: neovim-disable-autocomplete.lua
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/plugins/disable-autocomplete.lua"
    mode: '0644'

- name: Deploy Neovim hidden files config
  ansible.builtin.copy:
    src: neovim-show-hidden-files.lua
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/plugins/show-hidden-files.lua"
    mode: '0644'
