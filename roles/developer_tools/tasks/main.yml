---
# ============================================================================
# PACMAN PACKAGES
# ============================================================================

- name: Install packages via pacman
  community.general.pacman:
    name: "{{ pacman_packages_to_install | map(attribute='name') | list }}"
    state: present
  become: true
  when: pacman_packages_to_install is defined and pacman_packages_to_install | length > 0

# ============================================================================
# AUR PACKAGES
# ============================================================================

- name: Install packages via AUR
  kewlfft.aur.aur:
    name: "{{ item.name }}"
    use: yay
    state: present
    extra_args: "--noconfirm"
  loop: "{{ aur_packages_to_install }}"
  when: aur_packages_to_install is defined and aur_packages_to_install | length > 0
  become: true
  become_user: aur_builder

# ============================================================================
# SNAPD CONFIGURATION
# ============================================================================

- name: Enable snapd socket
  ansible.builtin.systemd:
    name: snapd.socket
    enabled: true
    state: started
  become: true
  when: "'snapd' in aur_packages_to_install | map(attribute='name') | list"

- name: Enable snapd AppArmor service
  ansible.builtin.systemd:
    name: snapd.apparmor.service
    enabled: true
    state: started
  become: true
  failed_when: false
  when: "'snapd' in aur_packages_to_install | map(attribute='name') | list"

- name: Create symlink for classic snap support
  ansible.builtin.file:
    src: /var/lib/snapd/snap
    dest: /snap
    state: link
  become: true
  when: "'snapd' in aur_packages_to_install | map(attribute='name') | list"

- name: Install snapcraft via snap
  community.general.snap:
    name: snapcraft
    classic: true
    state: present
  become: true
  when: "'snapd' in aur_packages_to_install | map(attribute='name') | list"

- name: Add snap bin to PATH in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    line: 'export PATH="$PATH:/snap/bin"'
    state: present
    regexp: 'export PATH=.*:/snap/bin'
  when: "'snapd' in aur_packages_to_install | map(attribute='name') | list"

# ============================================================================
# FLATPAK PACKAGES
# ============================================================================

- name: Install packages via Flatpak
  community.general.flatpak:
    name: "{{ item.name }}"
    state: present
    remote: flathub
  loop: "{{ flatpak_packages_to_install }}"
  when: flatpak_packages_to_install is defined and flatpak_packages_to_install | length > 0

# ============================================================================
# PIPX PACKAGES
# ============================================================================

- name: Configure pipx PATH for current user
  ansible.builtin.command: pipx ensurepath
  changed_when: "'already' not in pipx_ensurepath.stdout"
  failed_when: false
  register: pipx_ensurepath
  when: "'python-pipx' in pacman_packages_to_install | map(attribute='name') | list"

- name: Install packages via pipx
  ansible.builtin.command:
    cmd: "pipx install {{ item.name }}"
  loop: "{{ pipx_packages_to_install }}"
  when:
    - pipx_packages_to_install is defined
    - pipx_packages_to_install | length > 0
    - "'python-pipx' in pacman_packages_to_install | map(attribute='name') | list"
  changed_when: "'installed package' in pipx_install_result.stdout"
  failed_when: pipx_install_result.rc != 0 and 'already seems to be installed' not in pipx_install_result.stderr
  register: pipx_install_result

# ============================================================================
# NODE.JS AND NPM PACKAGES
# ============================================================================

- name: Install Node.js globally via mise
  ansible.builtin.command:
    cmd: "mise use -g node@lts"
  changed_when: "'installed' in mise_node_install.stderr or 'installed' in mise_node_install.stdout"
  failed_when: mise_node_install.rc != 0
  register: mise_node_install

- name: Install npm packages globally via mise
  ansible.builtin.command:
    cmd: "mise exec -- npm install -g {{ npm_packages_to_install | map(attribute='name') | join(' ') }}"
  when: npm_packages_to_install is defined and npm_packages_to_install | length > 0
  changed_when: "'added' in npm_install_result.stdout or 'updated' in npm_install_result.stdout"
  failed_when: npm_install_result.rc != 0
  register: npm_install_result

# ============================================================================
# ANDROID SDK CONFIGURATION
# ============================================================================

- name: Check if Android SDK exists in /opt
  ansible.builtin.stat:
    path: /opt/android-sdk
  register: android_sdk_opt
  when: aur_packages_to_install is defined

- name: Check if Android SDK already exists in home directory
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/android-sdk"
  register: android_sdk_home
  when: aur_packages_to_install is defined

- name: Copy Android SDK to home directory
  ansible.builtin.command:
    cmd: cp -R /opt/android-sdk {{ ansible_facts['env']['HOME'] }}/
  when:
    - aur_packages_to_install is defined
    - android_sdk_opt.stat.exists
    - not android_sdk_home.stat.exists
  become: true
  register: android_sdk_copied

- name: Set ownership of Android SDK in home directory
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/android-sdk"
    owner: "{{ ansible_facts['user_id'] }}"
    group: "{{ ansible_facts['user_id'] }}"
    recurse: true
  when:
    - aur_packages_to_install is defined
    - android_sdk_copied is defined
    - android_sdk_copied.changed
  become: true

- name: Configure Android environment variables in .bashrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Flutter Android SDK"
    block: |
      export ANDROID_HOME=$HOME/android-sdk
      export PATH=$PATH:$ANDROID_HOME/platform-tools
      export JAVA_HOME=/usr/lib/jvm/java-17-openjdk
      export ANDROID_AVD_HOME=$HOME/.config/.android/avd
  when: aur_packages_to_install is defined

- name: Create .android directory for AVD symlink
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.android"
    state: directory
    mode: '0755'
  when: aur_packages_to_install is defined

- name: Check if Android licenses are already accepted
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/android-sdk/licenses/android-sdk-license"
  register: android_licenses_file
  when:
    - flutter_install_dir is defined
    - aur_packages_to_install is defined
    - android_sdk_home.stat.exists or (android_sdk_copied is defined and android_sdk_copied.changed)

- name: Accept Android licenses
  ansible.builtin.shell: |
    yes | {{ flutter_install_dir }}/flutter/bin/flutter doctor --android-licenses
  register: android_licenses
  changed_when: "'All SDK package licenses accepted' in android_licenses.stdout"
  failed_when: false
  when:
    - flutter_install_dir is defined
    - aur_packages_to_install is defined
    - android_sdk_home.stat.exists or (android_sdk_copied is defined and android_sdk_copied.changed)
    - android_licenses_file is defined
    - not android_licenses_file.stat.exists

- name: Install Android system images for emulators
  ansible.builtin.shell: |
    yes | {{ ansible_facts['env']['HOME'] }}/android-sdk/cmdline-tools/latest/bin/sdkmanager "{{ item }}"
  loop: "{{ android_system_images }}"
  when:
    - android_system_images is defined
    - android_sdk_home.stat.exists or (android_sdk_copied is defined and android_sdk_copied.changed)
  changed_when: "'Installing' in android_system_images_install.stdout"
  failed_when: false
  register: android_system_images_install

- name: Update Android SDK components
  ansible.builtin.shell: |
    yes | {{ ansible_facts['env']['HOME'] }}/android-sdk/cmdline-tools/latest/bin/sdkmanager --update
  when:
    - aur_packages_to_install is defined
    - android_sdk_home.stat.exists
  changed_when: "'installed' in android_sdk_update.stdout or 'updated' in android_sdk_update.stdout"
  failed_when: false
  register: android_sdk_update

# ============================================================================
# FLUTTER SDK
# ============================================================================

- name: Create development directory
  ansible.builtin.file:
    path: "{{ flutter_install_dir }}"
    state: directory
    mode: '0755'
  when: flutter_install_dir is defined

- name: Check if Flutter is already installed
  ansible.builtin.stat:
    path: "{{ flutter_install_dir }}/flutter"
  register: flutter_installed
  when: flutter_install_dir is defined

- name: Fetch Flutter releases metadata
  ansible.builtin.uri:
    url: "{{ flutter_releases_url }}"
    return_content: true
  register: flutter_releases_data
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists

- name: Extract latest stable release info
  ansible.builtin.set_fact:
    flutter_latest_stable: "{{ flutter_releases_data.json.releases | selectattr('channel', 'equalto', 'stable') | first }}"
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists
    - flutter_releases_data is defined

- name: Download Flutter SDK tarball
  ansible.builtin.get_url:
    url: "https://storage.googleapis.com/flutter_infra_release/releases/{{ flutter_latest_stable.archive }}"
    dest: "/tmp/flutter_linux_stable.tar.xz"
    mode: '0644'
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists
    - flutter_latest_stable is defined
  register: flutter_download

- name: Extract Flutter SDK
  ansible.builtin.unarchive:
    src: "/tmp/flutter_linux_stable.tar.xz"
    dest: "{{ flutter_install_dir }}/"
    remote_src: true
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists
    - flutter_latest_stable is defined
  register: flutter_extract

- name: Clean up Flutter tarball
  ansible.builtin.file:
    path: "/tmp/flutter_linux_stable.tar.xz"
    state: absent
  when:
    - flutter_install_dir is defined
    - flutter_download is defined
    - flutter_download.changed

- name: Add Flutter to PATH in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    line: 'export PATH="$PATH:{{ flutter_install_dir }}/flutter/bin"'
    state: present
    regexp: 'export PATH="\$PATH:.*/flutter/bin"'
  when: flutter_install_dir is defined

- name: Configure CHROME_EXECUTABLE for Flutter web development
  ansible.builtin.lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    line: 'export CHROME_EXECUTABLE=/usr/bin/brave'
    state: present
    regexp: 'export CHROME_EXECUTABLE=.*'
  when: flutter_install_dir is defined

- name: Check Flutter analytics status
  ansible.builtin.shell: |
    {{ flutter_install_dir }}/flutter/bin/flutter config
  register: flutter_config
  changed_when: false
  failed_when: false
  when:
    - flutter_install_dir is defined
    - flutter_installed.stat.exists or (flutter_extract is defined and flutter_extract.changed)

- name: Disable Flutter analytics
  ansible.builtin.shell: |
    {{ flutter_install_dir }}/flutter/bin/flutter config --no-analytics
  when:
    - flutter_install_dir is defined
    - flutter_config is defined
    - flutter_config.stdout is defined
    - '"Analytics reporting is currently disabled" not in flutter_config.stdout'
