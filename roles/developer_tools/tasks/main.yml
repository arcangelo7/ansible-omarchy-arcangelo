---
# ============================================================================
# PACMAN PACKAGES
# ============================================================================

- name: Install packages via pacman
  community.general.pacman:
    name: "{{ item.name }}"
    state: present
    update_cache: true
  loop: "{{ pacman_packages_to_install }}"
  when: pacman_packages_to_install is defined and pacman_packages_to_install | length > 0
  become: true
  register: pacman_install_result

- name: Show pacman packages installation results
  debug:
    msg: "{{ item.item.name }} ({{ item.item.description }}) - Status: {{ 'Installed' if item.changed else 'Already present' }}"
  loop: "{{ pacman_install_result.results }}"
  when: pacman_install_result is defined

# ============================================================================
# AUR PACKAGES
# ============================================================================

- name: Install packages via AUR
  kewlfft.aur.aur:
    name: "{{ item.name }}"
    use: yay
    state: present
    extra_args: "--noconfirm"
  loop: "{{ aur_packages_to_install }}"
  when: aur_packages_to_install is defined and aur_packages_to_install | length > 0
  become: true
  become_user: aur_builder
  register: aur_install_result

- name: Show AUR packages installation results
  debug:
    msg: "{{ item.item.name }} ({{ item.item.description }}) - Status: {{ 'Installed' if item.changed else 'Already present' }}"
  loop: "{{ aur_install_result.results }}"
  when: aur_install_result is defined

# ============================================================================
# PIPX PACKAGES
# ============================================================================

- name: Configure pipx PATH for current user
  ansible.builtin.command: pipx ensurepath
  register: pipx_ensurepath
  changed_when: "'already' not in pipx_ensurepath.stdout"
  failed_when: false
  when: "'python-pipx' in pacman_packages_to_install | map(attribute='name') | list"

- name: Show pipx ensurepath result
  debug:
    msg: "pipx PATH configuration - Status: {{ 'Configured' if pipx_ensurepath.changed else 'Already configured' }}"
  when:
    - pipx_ensurepath is defined
    - "'python-pipx' in pacman_packages_to_install | map(attribute='name') | list"

- name: Install packages via pipx
  ansible.builtin.command:
    cmd: "pipx install {{ item.name }}"
  loop: "{{ pipx_packages_to_install }}"
  when:
    - pipx_packages_to_install is defined
    - pipx_packages_to_install | length > 0
    - "'python-pipx' in pacman_packages_to_install | map(attribute='name') | list"
  register: pipx_install_result
  changed_when: "'installed package' in pipx_install_result.stdout"
  failed_when: pipx_install_result.rc != 0 and 'already seems to be installed' not in pipx_install_result.stderr

- name: Show pipx packages installation results
  debug:
    msg: "{{ item.item.name }} ({{ item.item.description }}) - Status: {{ 'Installed' if item.changed else 'Already present' }}"
  loop: "{{ pipx_install_result.results }}"
  when: pipx_install_result is defined

# ============================================================================
# NODE.JS AND NPM PACKAGES
# ============================================================================

- name: Install Node.js globally via mise
  ansible.builtin.command:
    cmd: "mise use -g node@lts"
  register: mise_node_install
  changed_when: "'installed' in mise_node_install.stderr or 'installed' in mise_node_install.stdout"
  failed_when: mise_node_install.rc != 0

- name: Show Node.js installation status
  debug:
    msg: "Node.js installation status: {{ 'Installed' if mise_node_install.changed else 'Already present' }}"

- name: Install npm packages globally via mise
  ansible.builtin.command:
    cmd: "mise exec -- npm install -g {{ item.name }}"
  loop: "{{ npm_packages_to_install }}"
  when: npm_packages_to_install is defined and npm_packages_to_install | length > 0
  register: npm_install_result
  changed_when: "'added' in npm_install_result.stdout or 'updated' in npm_install_result.stdout"
  failed_when: npm_install_result.rc != 0

- name: Show npm package installation results
  debug:
    msg: "{{ item.item.name }} ({{ item.item.description }}) - Status: {{ 'Installed/Updated' if item.changed else 'Already present' }}"
  loop: "{{ npm_install_result.results }}"
  when: npm_install_result is defined

# ============================================================================
# ANDROID SDK CONFIGURATION
# ============================================================================

- name: Check if Android SDK exists in /opt
  ansible.builtin.stat:
    path: /opt/android-sdk
  register: android_sdk_opt
  when: aur_packages_to_install is defined

- name: Check if Android SDK already exists in home directory
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/android-sdk"
  register: android_sdk_home
  when: aur_packages_to_install is defined

- name: Copy Android SDK to home directory
  ansible.builtin.command:
    cmd: cp -R /opt/android-sdk {{ ansible_env.HOME }}/
  when:
    - aur_packages_to_install is defined
    - android_sdk_opt.stat.exists
    - not android_sdk_home.stat.exists
  become: true
  register: android_sdk_copied

- name: Set ownership of Android SDK in home directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/android-sdk"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    recurse: true
  when:
    - aur_packages_to_install is defined
    - android_sdk_home.stat.exists or (android_sdk_copied is defined and android_sdk_copied.changed)
  become: true

- name: Configure Android environment variables in .bashrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Flutter Android SDK"
    block: |
      export ANDROID_HOME=$HOME/android-sdk
      export PATH=$PATH:$ANDROID_HOME/platform-tools
      export JAVA_HOME=/usr/lib/jvm/java-17-openjdk
      export ANDROID_AVD_HOME=$HOME/.config/.android/avd
  when: aur_packages_to_install is defined

- name: Create .android directory for AVD symlink
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.android"
    state: directory
    mode: '0755'
  when: aur_packages_to_install is defined

- name: Accept Android licenses
  ansible.builtin.shell: |
    yes | {{ flutter_install_dir }}/flutter/bin/flutter doctor --android-licenses
  register: android_licenses
  changed_when: "'All SDK package licenses accepted' in android_licenses.stdout"
  failed_when: false
  when:
    - flutter_install_dir is defined
    - aur_packages_to_install is defined
    - android_sdk_home.stat.exists or (android_sdk_copied is defined and android_sdk_copied.changed)

- name: Show Android licenses acceptance status
  debug:
    msg: "Android licenses - Status: {{ 'Accepted' if android_licenses.changed else 'Already accepted or Flutter not yet installed' }}"
  when:
    - aur_packages_to_install is defined
    - android_licenses is defined

- name: Install Android system images for emulators
  ansible.builtin.shell: |
    yes | {{ ansible_env.HOME }}/android-sdk/cmdline-tools/latest/bin/sdkmanager "{{ item }}"
  loop: "{{ android_system_images }}"
  when:
    - android_system_images is defined
    - android_sdk_home.stat.exists or (android_sdk_copied is defined and android_sdk_copied.changed)
  register: android_system_images_install
  changed_when: "'Installing' in android_system_images_install.stdout"
  failed_when: false

- name: Show Android system images installation status
  debug:
    msg: "Android system image {{ item.item }} - Status: {{ 'Installed' if item.changed else 'Already present' }}"
  loop: "{{ android_system_images_install.results }}"
  when:
    - android_system_images is defined
    - android_system_images_install is defined

- name: Update Android SDK components
  ansible.builtin.shell: |
    yes | {{ ansible_env.HOME }}/android-sdk/cmdline-tools/latest/bin/sdkmanager --update
  when:
    - aur_packages_to_install is defined
    - android_sdk_home.stat.exists
  register: android_sdk_update
  changed_when: "'installed' in android_sdk_update.stdout or 'updated' in android_sdk_update.stdout"
  failed_when: false

- name: Show Android SDK update status
  debug:
    msg: "Android SDK components - Status: {{ 'Updated' if android_sdk_update.changed else 'Already up-to-date' }}"
  when:
    - aur_packages_to_install is defined
    - android_sdk_update is defined

# ============================================================================
# FLUTTER SDK
# ============================================================================

- name: Create development directory
  ansible.builtin.file:
    path: "{{ flutter_install_dir }}"
    state: directory
    mode: '0755'
  when: flutter_install_dir is defined

- name: Check if Flutter is already installed
  ansible.builtin.stat:
    path: "{{ flutter_install_dir }}/flutter"
  register: flutter_installed
  when: flutter_install_dir is defined

- name: Fetch Flutter releases metadata
  ansible.builtin.uri:
    url: "{{ flutter_releases_url }}"
    return_content: true
  register: flutter_releases_data
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists

- name: Extract latest stable release info
  ansible.builtin.set_fact:
    flutter_latest_stable: "{{ flutter_releases_data.json.releases | selectattr('channel', 'equalto', 'stable') | first }}"
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists
    - flutter_releases_data is defined

- name: Show Flutter version to be installed
  debug:
    msg: "Installing Flutter {{ flutter_latest_stable.version }} (latest stable)"
  when:
    - flutter_install_dir is defined
    - flutter_latest_stable is defined

- name: Download Flutter SDK tarball
  ansible.builtin.get_url:
    url: "https://storage.googleapis.com/flutter_infra_release/releases/{{ flutter_latest_stable.archive }}"
    dest: "/tmp/flutter_linux_stable.tar.xz"
    mode: '0644'
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists
    - flutter_latest_stable is defined
  register: flutter_download

- name: Show Flutter download status
  debug:
    msg: "Flutter SDK tarball - Status: {{ 'Downloaded' if flutter_download.changed else 'Already present' }}"
  when:
    - flutter_install_dir is defined
    - flutter_download is defined

- name: Extract Flutter SDK
  ansible.builtin.unarchive:
    src: "/tmp/flutter_linux_stable.tar.xz"
    dest: "{{ flutter_install_dir }}/"
    remote_src: true
  when:
    - flutter_install_dir is defined
    - not flutter_installed.stat.exists
    - flutter_latest_stable is defined
  register: flutter_extract

- name: Show Flutter extraction status
  debug:
    msg: "Flutter SDK - Status: {{ 'Extracted' if flutter_extract.changed else 'Already present' }}"
  when:
    - flutter_install_dir is defined
    - flutter_extract is defined

- name: Clean up Flutter tarball
  ansible.builtin.file:
    path: "/tmp/flutter_linux_stable.tar.xz"
    state: absent
  when:
    - flutter_install_dir is defined
    - flutter_download is defined
    - flutter_download.changed

- name: Add Flutter to PATH in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export PATH="$PATH:{{ flutter_install_dir }}/flutter/bin"'
    state: present
    regexp: 'export PATH="\$PATH:.*/flutter/bin"'
  when: flutter_install_dir is defined

- name: Configure CHROME_EXECUTABLE for Flutter web development
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export CHROME_EXECUTABLE=/usr/bin/brave'
    state: present
    regexp: 'export CHROME_EXECUTABLE=.*'
  when: flutter_install_dir is defined

- name: Check Flutter analytics status
  ansible.builtin.shell: |
    {{ flutter_install_dir }}/flutter/bin/flutter config
  register: flutter_config
  changed_when: false
  failed_when: false
  when:
    - flutter_install_dir is defined
    - flutter_installed.stat.exists or (flutter_extract is defined and flutter_extract.changed)

- name: Disable Flutter analytics
  ansible.builtin.shell: |
    {{ flutter_install_dir }}/flutter/bin/flutter config --no-analytics
  when:
    - flutter_install_dir is defined
    - flutter_config is defined
    - flutter_config.stdout is defined
    - '"Analytics reporting is currently disabled" not in flutter_config.stdout'
  register: flutter_analytics_disabled

- name: Show Flutter analytics status
  debug:
    msg: "Flutter analytics - Status: {{ 'Disabled' if flutter_analytics_disabled.changed else 'Already disabled' }}"
  when:
    - flutter_install_dir is defined
    - flutter_config is defined
