---
- name: Deploy simplified keybindings configuration
  ansible.builtin.copy:
    src: bindings.conf
    dest: "{{ ansible_env.HOME }}/.config/hypr/bindings.conf"
    backup: true
    mode: '0644'

- name: Create .local/bin directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/bin"
    state: directory
    mode: '0755'

- name: Create whispering-toggle script
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.local/bin/whispering-toggle"
    content: |
      #!/bin/bash
      # Toggle Whispering recording by focusing the window and sending spacebar

      # Find Whispering window address
      WINDOW_ADDRESS=$(hyprctl clients -j | jq -r '.[] | select(.class=="whispering") | .address' | head -1)

      if [ -z "$WINDOW_ADDRESS" ]; then
          # Whispering not running, launch it
          whispering &
          sleep 2
          WINDOW_ADDRESS=$(hyprctl clients -j | jq -r '.[] | select(.class=="whispering") | .address' | head -1)
      fi

      if [ -n "$WINDOW_ADDRESS" ]; then
          # Focus Whispering window
          hyprctl dispatch focuswindow address:$WINDOW_ADDRESS
          sleep 0.1
          # Send spacebar to toggle recording
          ydotool key 57:1 57:0
      fi
    mode: '0755'

- name: Configure uinput module to load at boot
  ansible.builtin.copy:
    dest: /etc/modules-load.d/uinput.conf
    content: |
      uinput
    mode: '0644'
  become: true

- name: Add user to input group
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: input
    append: true
  become: true

- name: Enable ydotool service
  ansible.builtin.systemd:
    name: ydotool.service
    enabled: true
    scope: user
  ignore_errors: true

- name: Reload Hyprland configuration
  ansible.builtin.command: hyprctl reload
  ignore_errors: true
  register: hyprland_reload_result
  changed_when: hyprland_reload_result.rc == 0

- name: Show Hyprland reload result
  debug:
    msg: "Hyprland configuration reload - Status: {{ 'Success' if hyprland_reload_result.rc == 0 else 'Failed' }}"
  when: hyprland_reload_result is defined
